#language: ru

@tree




Функционал: Проверка корректности создания нового документа Обслуживание покупателя

Как Тестировщик я хочу
Я хочу сформировать отчёт и сверить его результат с данными из документов, 
чтобы убедиться, что отчёт считает корректно

Контекст:
	Дано Я подключаю клиент тестирования с параметрами:
		| 'Имя'        | 'Тип клиента' | 'Порт' | 'Строка соединения'                        | 'Логин'              | 'Пароль' |
		| 'ТестКлиент' | 'Тонкий'      | '1583' | 'File="F:\1С\Bases\DiplomWork(Netology)";' | 'Бухгалтер ИТ Фирмы' | ''       |
	И я закрываю все окна клиентского приложения

Сценарий: И я проверяю корректность результата отчета
	И В командном интерфейсе я выбираю "Обслуживание клиентов" "Анализ выставленных актов"
	Тогда открылось окно "Основной"
	И в поле с именем 'Период1ДатаНачала' я ввожу текст "01.02.2026"
	И в поле с именем 'Период1ДатаОкончания' я ввожу текст "28.02.2026"
	И я нажимаю на кнопку с именем 'СформироватьОтчет'

	
	
	
	
  # 3) Снимаем фактическую таблицу из отчёта (обычно это ТабличныйДокумент)
  И я выполняю код встроенного языка и сохраняю результат как "ФактТЗ"
    
    // Здесь важно привязаться к вашему конкретному отчёту:
    // - имя элемента формы табличного документа (например, "Результат")
    // - либо получение "ТекущийТабличныйДокумент" из формы
    //
    // Вариант А (типовой): в форме есть реквизит/элемент "Результат" типа ТабличныйДокумент
    ТабДок = ЭтаФорма.ЭлементыФормы.Результат.Значение;

    // Преобразуем табличный документ в таблицу значений (по видимым ячейкам)
    // Утилитарные функции могут отличаться. Если у вас есть общая функция конвертации — используйте её.
    ФактТЗ = Новый ТаблицаЗначений;
    ФактТЗ.Колонки.Добавить("Номенклатура");
    ФактТЗ.Колонки.Добавить("Количество");
    ФактТЗ.Колонки.Добавить("Сумма");

    // Пример чтения: предполагаем, что в табличном документе с 2-й строки идут данные:
    // Колонка 1 — Номенклатура, 2 — Количество, 3 — Сумма
    // Границы подберите под ваш макет отчёта.
    Для НомерСтроки = 2 По ТабДок.ВысотаТаблицы Цикл

        ЗначНоменклатура = ТабДок.ПолучитьТекст(НомерСтроки, 1);
        Если ПустаяСтрока(ЗначНоменклатура) Тогда
            Продолжить;
        КонецЕсли;

        НоваяСтрока = ФактТЗ.Добавить();
        НоваяСтрока.Номенклатура = ЗначНоменклатура;
        НоваяСтрока.Количество   = Число(ТабДок.ПолучитьТекст(НомерСтроки, 2));
        НоваяСтрока.Сумма        = Число(ТабДок.ПолучитьТекст(НомерСтроки, 3));

    КонецЦикла;

    Возврат ФактТЗ;
    

  # 4) Строим ожидаемые данные из документов (запросом по проведённым реализациям)
  И я выполняю код встроенного языка и сохраняю результат как "ОжидТЗ"
  И  я выполняю код встроенного языка
  """bsl
  Сообщить("Hello world.")
  """
    
    // Ожидаем агрегирование по номенклатуре: Количество и Сумма
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |   Товары.Номенклатура КАК Номенклатура,
    |   СУММА(Товары.Количество) КАК Количество,
    |   СУММА(Товары.Количество * Товары.Цена) КАК Сумма
    |ИЗ
    |   Документ.РеализацияТоваровУслуг.Товары КАК Товары
    |ГДЕ
    |   Товары.Ссылка В (&Ссылки)
    |СГРУППИРОВАТЬ ПО
    |   Товары.Номенклатура
    |УПОРЯДОЧИТЬ ПО
    |   Номенклатура";

    Ссылки = Новый Массив;
    Ссылки.Добавить(Контекст.СсылкаДок1);
    Ссылки.Добавить(Контекст.СсылкаДок2);

    Запрос.УстановитьПараметр("Ссылки", Ссылки);

    Результат = Запрос.Выполнить().Выгрузить();

    // При необходимости приводим представление номенклатуры к строке,
    // чтобы сравнение с табличным документом было корректным.
    Для Каждого Стр Из Результат Цикл
        Стр.Номенклатура = Стр.Номенклатура.Наименование;
    КонецЦикла;

    Возврат Результат;
    

  # 5) Нормализуем и сравниваем (сортировка, округление, контроль колонок)
  Тогда я выполняю код встроенного языка
    
    ФактТЗ = Контекст.ФактТЗ;
    ОжидТЗ = Контекст.ОжидТЗ;

    // Сортируем одинаково
    ФактТЗ.Сортировать("Номенклатура");
    ОжидТЗ.Сортировать("Номенклатура");

    // При необходимости: округление сумм
    Для Каждого Стр Из ФактТЗ Цикл
        Стр.Сумма = Окр(Стр.Сумма, 2);
    КонецЦикла;
    Для Каждого Стр Из ОжидТЗ Цикл
        Стр.Сумма = Окр(Стр.Сумма, 2);
    КонецЦикла;

    // Проверяем размер
    Если ФактТЗ.Количество() <> ОжидТЗ.Количество() Тогда
        ВызватьИсключение "Отчёт вернул строк: " + ФактТЗ.Количество()
            + ", ожидается: " + ОжидТЗ.Количество();
    КонецЕсли;

    // Построчное сравнение
    Для Инд = 0 По ФактТЗ.Количество() - 1 Цикл
        Ф = ФактТЗ[Инд];
        О = ОжидТЗ[Инд];

        Если Ф.Номенклатура <> О.Номенклатура Тогда
            ВызватьИсключение "Номенклатура отличается. Факт=" + Ф.Номенклатура + ", Ожид=" + О.Номенклатура;
        КонецЕсли;

        Если Ф.Количество <> О.Количество Тогда
            ВызватьИсключение "Количество отличается по " + Ф.Номенклатура + ". Факт=" + Ф.Количество + ", Ожид=" + О.Количество;
        КонецЕсли;

        Если Ф.Сумма <> О.Сумма Тогда
            ВызватьИсключение "Сумма отличается по " + Ф.Номенклатура + ". Факт=" + Ф.Сумма + ", Ожид=" + О.Сумма;
        КонецЕсли;
    КонецЦикла;







	И я закрываю все окна клиентского приложения
	И я закрываю сеанс текущего клиента тестирования